---
import Button from '../components/Button.astro';

interface Medicament {
	nom: string;
	dose: string;
}

interface Ordonnance {
	nom: string;
	date: string;
	nom_docteur: string;
	type_docteur: string;
	medicaments: Medicament[];
}

interface Utilisateur {
    prenom: string;
    nom: string;
    email: string;
}

// 1. On récupère les données en appelant notre API "côté serveur"
const response = await fetch(Astro.url.origin + '/api/profil.json');
const data: { utilisateur: Utilisateur; ordonnances: Ordonnance[] } = await response.json();
const { utilisateur, ordonnances: ordonnancesUtilisateur } = data;
---

<html lang="fr">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>Test des Models via API</title>
	</head>

	<body class="bg-gray-100 p-8">
		<main class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-md">
			<h1 class="text-3xl font-bold mb-4 text-purple-800">Test des "Models" basés sur la BDD</h1>
			<p class="mb-6 text-gray-700">
				Si vous voyez les informations ci-dessous, cela signifie que votre service
				(<code>src/services/database.service.ts</code>) et votre API fonctionnent parfaitement !
			</p>

			<!-- Section Utilisateur -->
			<div class="mb-8 p-4 border border-blue-200 rounded-lg bg-blue-50">
				<h2 class="text-2xl font-semibold text-blue-800">Profil Utilisateur</h2>
				<p><strong>Nom :</strong> {utilisateur.prenom} {utilisateur.nom}</p>
				<p><strong>Email :</strong> {utilisateur.email}</p>
			</div>

			<!-- Section Ordonnances -->
			<div class="space-y-6">
				<h2 class="text-2xl font-semibold text-gray-800">Ses Ordonnances</h2>
				{ordonnancesUtilisateur.map((ordonnance: Ordonnance) => (
					<div class="border border-gray-200 p-4 rounded-md">
						<h3 class="text-xl font-semibold text-purple-700">{ordonnance.nom}</h3>
						<p class="text-sm text-gray-500">Prescrit le {ordonnance.date} par {ordonnance.nom_docteur} ({ordonnance.type_docteur})</p>
						<ul class="list-disc list-inside mt-2 pl-4">
							{ordonnance.medicaments.map((medicament: Medicament) => (
								<li>{medicament.nom} ({medicament.dose})</li>
							))}
						</ul>
					</div>
				))}
			</div>

			<div class="mt-8 text-center">
				<a href="/">
					<Button>Retour à l'accueil</Button>
				</a>
			</div>
		</main>
	</body>
</html>